{# templates/subject/loss/report.html #}
{% extends "layout.html" %}
{% import "subject/loss/pdf/_macros.html" as M %}

{% block title %}Loss Results | AIT{% endblock %}

{% block content %}
{# —— Shared data —— #}
{% set phase_labels = {1:'Impact', 2:'Hopelessness', 3:'Helplessness', 4:'Re-Engagement'} %}
{% set blocks = phase_blocks | default([], true) %}
{% set oa = overall_assessment | default(None) %}
{% set viewer_is_admin = viewer_is_admin | default(false) %}
{% set pdf_mode = false %}

{# Graph & chip styles used by both on-screen and PDF #}
{% include "subject/loss/pdf/_styles.html" %}

{# —— Top bar —— #}
<div class="mx-auto w-full max-w-6xl px-6 py-6">
  <div class="relative">
    <div class="pr-0 md:pr-[360px]">
      <h1 class="text-2xl font-semibold text-slate-900">Assessment Results</h1>
    </div>

    <!-- “Back to site” tile (right) -->
    <div class="mt-4 md:mt-0 md:absolute md:top-0 md:right-0 md:w-[340px]">
      <div class="rounded-2xl border border-slate-200 bg-white shadow-sm">
        <div class="h-1.5 w-full rounded-t-2xl bg-blue-600"></div>
        <div class="p-4">
          <p class="text-[15px] leading-5 text-slate-700">
            Press <span class="font-semibold">Back to site</span> to go to the
            finish page, where you can <span class="font-medium">email / save / print</span>
            your report. Your session will end afterwards and you’ll return to the AIT site.
          </p>
          <a href="{{ url_for('loss_bp.report_exit', run_id=run_id, user_id=user_id) }}"
             class="mt-3 inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white hover:bg-blue-700 focus:outline-none">
            Back to site
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

{# —— Header (rows 1–3) —— #}
<div class="mx-auto w-full max-w-6xl px-6">
  {% include "subject/loss/pdf/_header.html" %}
</div>

<div class="mx-auto w-full max-w-6xl px-6 pb-8 space-y-6">
  {% if blocks|length == 0 %}
    <div class="rounded-xl border border-amber-200 p-4 bg-amber-50 text-amber-800">
      No phase data available for this run.
    </div>
  {% endif %}

  {# —— Phases —— #}
  {% for blk in blocks %}
    {% set pct  = (blk.pct if blk.pct is defined else (blk.width_pct if blk.width_pct is defined else 0)) | int %}
    {% set band = blk.band if blk.band is defined else (3 if pct>=70 else (2 if pct>=40 else 1)) %}

    {% if blk.phase in [1,2,3] %}
      {% set av_txt     = 'Not Coping' if band==3 else ('Slightly Coping' if band==2 else 'Coping') %}
      {% set range_chip = 'chip-emerald' if band==1 else ('chip-amber' if band==2 else 'chip-rose') %}
      {% set bar_color  = 'bar-emerald' if band==1 else ('bar-amber' if band==2 else 'bar-rose') %}
    {% else %}
      {% set av_txt     = 'Coping' if band==3 else ('Slightly Coping' if band==2 else 'Not Coping') %}
      {% set range_chip = 'chip-blue' if band==1 else ('chip-lightemerald' if band==2 else 'chip-emerald') %}
      {% set bar_color  = 'bar-blue' if band==1 else ('bar-mint' if band==2 else 'bar-emerald') %}
    {% endif %}

    {% set av_chip = 'chip-av-coping' if av_txt=='Coping'
                    else ('chip-av-slightlycoping' if av_txt=='Slightly Coping' else 'chip-av-notcoping') %}

    <section class="phase-card rounded-2xl border border-slate-200 p-5 bg-white">
      {% include "subject/loss/pdf/_phase_heading.html" %}
      {% include "subject/loss/pdf/_bar_graph.html" %}
      {% include "subject/loss/pdf/_phase_body.html" %}
      {% include "subject/loss/pdf/_progress.html" %}
    </section>
  {% endfor %}

  {# —— Phase Summary —— #}
  {% include "subject/loss/pdf/_summary.html" %}

  <!-- Overall Assessment (card) -->
  <section class="mt-8 rounded-2xl border border-slate-200 bg-white shadow-sm">
    <div class="h-1.5 w-full rounded-t-2xl bg-blue-600"></div>
    <div class="p-5">
      {% include "subject/loss/pdf/_overall_assessment.html" %}
    </div>
  </section>

  <!-- Donation (card) -->
  <section class="mt-6 rounded-2xl border border-slate-200 bg-white shadow-sm">
    <div class="h-1.5 w-full rounded-t-2xl bg-emerald-600"></div>
    <div class="p-5">
      {% include "subject/loss/pdf/_donation_bank_details.html" %}
    </div>
  </section>

  <!-- Disclaimer (card) -->
  <section class="mt-6 rounded-2xl border border-slate-200 bg-white shadow-sm">
    <div class="h-1.5 w-full rounded-t-2xl bg-slate-600"></div>
    <div class="p-5">
      {% include "subject/loss/pdf/_disclaimer.html" %}
    </div>
  </section>

</div>  {# closes the .max-w-6xl container #}
{% endblock %}
