{% extends "layout.html" %}
{% block title %}BudgetCash · Cashbook{% endblock %}

{% block content %}
<div class="mx-auto max-w-5xl mt-10 bg-white shadow rounded-lg p-6">

  <!-- Header -->
    <h1 class="text-lg font-semibold text-slate-900">
        BudgetCash · Cashbook
    </h1>

    <div class="flex items-center gap-4 text-sm">
        <a href="{{ url_for('budget_bp.account_new', next=request.full_path) }}"
            class="text-sky-700 hover:underline">New account</a>

        <a href="{{ url_for('budget_bp.report_income_expense') }}"
            class="text-sky-700 hover:underline">Income statement</a>

        <a href="{{ url_for('budget_bp.help_guide') }}"
            class="text-sky-700 hover:underline">Help</a>

        <!--a href="{{ url_for('budget_bp.dashboard') }}"
            class="rounded border border-slate-300 px-3 py-1.5 hover:bg-slate-50">
            ← Back
        </a-->

        <a href="{{ back_url }}"
            class="rounded border border-slate-300 px-3 py-1.5 hover:bg-slate-50">
            ← Back
        </a>


    </div>


  <!-- LOOKUP -->
  <div class="mt-6 rounded border border-slate-200 bg-slate-50/60 p-4">

    <div class="flex items-center justify-between">
      <div>
        <div class="font-semibold text-slate-900">Lookup</div>
        <p class="text-xs text-slate-500 mt-1">
          Use lookup to view account history and copy statement information when resolving queries.
        </p>
      </div>

      {% if account_id and account_id|string|trim and account_id|string|trim|int > 0 %}
        <a href="{{ url_for('budget_bp.account_edit', account_id=account_id|int) }}"
           class="text-sm text-sky-700 hover:underline">
          Edit account details
        </a>
      {% endif %}
    </div>

    <form id="lookup_form" class="mt-3 grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
      <div class="md:col-span-5">
        <label class="block text-xs font-medium text-slate-600 mb-1">Account</label>
        <select id="lookup_account_id"
                class="w-full rounded border border-slate-300 px-3 py-2 text-sm">
          <option value="">Choose account…</option>
          {% for a in accounts %}
            <option value="{{ a.id }}" {% if account_id and (a.id|string)==(account_id|string) %}selected{% endif %}>
              {{ a.kind|title }} · {{ a.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <button id="lookup_btn" type="button"
              class="md:col-span-1 rounded bg-slate-900 text-white px-4 py-2.5 text-sm font-medium hover:bg-slate-800">
        Lookup
      </button>
    </form>

    <script>
    (function () {
      const sel = document.getElementById("lookup_account_id");
      const btn = document.getElementById("lookup_btn");
      if (!sel || !btn) return;

      btn.addEventListener("click", function () {
        const id = (sel.value || "").trim();
        if (!id) return;
        // Keep your existing flow: lookup = go to account detail
        const base = "{{ url_for('budget_bp.account_detail', account_id=0) }}";
        window.location = base.replace("/0", "/" + id);
      });
    })();
    </script>

  </div>


  <!-- CASHBOOK ENTRY -->
  <div class="mt-6 rounded border border-slate-200 bg-sky-50/60 p-4">

    <div class="font-semibold text-slate-900">Add payment</div>

    <form method="post" action="{{ url_for('budget_bp.ledger_add') }}"
          class="mt-3 grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" id="description" name="description" value="Paid">

      <div class="md:col-span-3">
        <label class="block text-xs font-medium text-slate-600 mb-1">Account</label>
        <select id="pay_account_id" name="account_id"
                class="w-full rounded border border-slate-300 px-3 py-2 text-sm" required>
          <option value="">Select account…</option>
          {% for a in accounts %}
            <option value="{{ a.id }}">{{ a.kind|title }} · {{ a.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="md:col-span-1">
        <label class="block text-xs font-medium text-slate-600 mb-1">Date</label>
        <input name="txn_date" type="date"
               class="w-full rounded border border-slate-300 px-3 py-2 text-sm" required>
      </div>

      <div class="md:col-span-2">
        <label class="block text-xs font-medium text-slate-600 mb-1">Paid</label>
        <input name="amount" inputmode="decimal" placeholder="e.g. 200.00"
               class="w-full rounded border border-slate-300 px-3 py-2 text-sm" required>
      </div>

      <div class="md:col-span-6">
        <button class="w-full rounded bg-sky-600 text-white px-4 py-2.5 text-sm font-medium hover:bg-sky-700">
          Add payment
        </button>
      </div>
    </form>
  </div>

  <!-- TRANSACTIONS -->
  <div class="mt-6 rounded border border-slate-200 p-4">
    <div class="flex items-center justify-between">
      <div class="font-semibold text-slate-900">Transactions</div>
      {% if request.args.get('account_id') %}
        <div class="text-xs text-slate-500">Showing account ID: {{ request.args.get('account_id') }}</div>
      {% endif %}
    </div>

    {% if ledger_rows %}
      <div class="mt-3 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-slate-500 border-b">
            <tr>
            <th class="text-left py-2 pr-4 font-medium">Date</th>
            <th class="text-left py-2 pr-4 font-medium">Account</th>
            <th class="text-right py-2 pl-4 font-medium">Paid</th>
            <th class="text-right py-2 pl-4 font-medium">Edit</th>
            </tr>

          </thead>
          <tbody class="divide-y">
            {% for r in ledger_rows %}
                <tr>
                <td class="py-2 pr-4">{{ r.txn_date }}</td>
                <td class="py-2 pr-4">{{ r.account_name }}</td>
                <td class="py-2 pl-4 text-right">{{ '%.2f'|format((r.amount_cents|int)/100) }}</td>
                <td class="py-2 pl-4 text-right">
                    <a class="text-sky-700 hover:underline"
                    href="{{ url_for('budget_bp.ledger_edit', ledger_id=r.id, next=request.full_path) }}">
                    Edit
                    </a>
                </td>
                </tr>

            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="mt-3 text-sm text-slate-500">No transactions yet.</div>
    {% endif %}
  </div>

</div>
{% endblock %}
