{# templates/subject/loss/report_pdf.html #}
{% import "subject/loss/pdf/_macros.html" as M %}

<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Loss Assessment Report</title>
  {# PDF-specific styles (phase cards, chips, bars, etc.) #}
  {% include "subject/loss/pdf/_styles.html" %}
</head>
<body class="loss-report">

  {# ---- Safe context defaults ---- #}
  {% set phase_labels = {1:'Impact', 2:'Hopelessness', 3:'Helplessness', 4:'Re-Engagement'} %}
  {% set blocks = phase_blocks | default([], true) %}
  {% set oa = overall_assessment | default(None) %}
  {% set viewer_is_admin = viewer_is_admin | default(false) %}
  {% set pdf_mode = true %}

  <div class="mx-auto w-full max-w-6xl px-6 pb-8">

    {# ---- Header row (Loss • email • Run • timestamp) ---- #}
    {% include "subject/loss/pdf/_header.html" %}

    {% if blocks|length == 0 %}
      <div class="rounded-xl border border-amber-200 p-4 bg-amber-50 text-amber-800" style="margin-top:16px;">
        No phase data available for this run.
      </div>
    {% endif %}

    {# ---- Per-phase sections (same logic as screen, but no “Back to site” tile) ---- #}
    {% for blk in blocks %}
      {% set pct  = (blk.pct if blk.pct is defined else (blk.width_pct if blk.width_pct is defined else 0)) | int %}
      {% set band = blk.band if blk.band is defined else (3 if pct>=70 else (2 if pct>=40 else 1)) %}

      {% if blk.phase in [1,2,3] %}
        {% set av_txt     = 'Not Coping' if band==3 else ('Slightly Coping' if band==2 else 'Coping') %}
        {% set range_chip = 'chip-emerald' if band==1 else ('chip-amber' if band==2 else 'chip-rose') %}
        {% set bar_color  = 'bar-emerald' if band==1 else ('bar-amber' if band==2 else 'bar-rose') %}
      {% else %}
        {% set av_txt     = 'Coping' if band==3 else ('Slightly Coping' if band==2 else 'Not Coping') %}
        {% set range_chip = 'chip-blue' if band==1 else ('chip-lightemerald' if band==2 else 'chip-emerald') %}
        {% set bar_color  = 'bar-blue' if band==1 else ('bar-mint' if band==2 else 'bar-emerald') %}
      {% endif %}

      {% set av_chip = 'chip-av-coping' if av_txt=='Coping'
                      else ('chip-av-slightlycoping' if av_txt=='Slightly Coping' else 'chip-av-notcoping') %}

      <section class="phase-card rounded-2xl border border-slate-200 p-5 bg-white" style="page-break-inside:avoid; margin-top:18px;">
        {% include "subject/loss/pdf/_phase_heading.html" %}
        {% include "subject/loss/pdf/_bar_graph.html" %}
        {% include "subject/loss/pdf/_phase_body.html" %}
        {% include "subject/loss/pdf/_progress.html" %}
      </section>
    {% endfor %}

    {# ---- Phase Summary ---- #}
    <section style="page-break-inside:avoid; margin-top:24px;">
      {% include "subject/loss/pdf/_summary.html" %}
    </section>

    {# ---- Overall Assessment ---- #}
    <section style="page-break-inside:avoid; margin-top:24px;">
      {% include "subject/loss/pdf/_overall_assessment.html" %}
    </section>

    {# ---- Donation note (plain block, no tiles) ---- #}
    <section style="page-break-inside:avoid; margin-top:24px;">
      {% include "subject/loss/pdf/_donation_bank_details.html" %}
    </section>

    {# ---- Disclaimer ---- #}
    <section style="page-break-inside:avoid; margin-top:24px;">
      {% include "subject/loss/pdf/_disclaimer.html" %}
    </section>

  </div>
</body>
</html>
