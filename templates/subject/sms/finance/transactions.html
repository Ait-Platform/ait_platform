{# templates/subject/sms/finance/transactions.html #}
{% extends "layout.html" %}
{% block title %}Cashbook · SMS{% endblock %}
{% block flashes %}{% endblock %}

{% block content %}
<div class="mx-auto max-w-4xl mt-8 bg-white shadow rounded-lg p-6">

  <div class="flex items-center justify-between mb-4">
    <div>
      <h1 class="text-lg font-semibold text-slate-900">Cashbook</h1>
      <p class="text-xs text-slate-500">
        {{ school.short_code or school.name }} · Record all income and expenses for the year.
      </p>
    </div>

    <a href="{{ url_for('sms_bp.finance_home') }}"
       class="text-xs text-indigo-600 hover:underline">
      ← Back
    </a>
  </div>

  {# Flash messages inside tile; audit-only messages hidden #}
  {% with msgs = get_flashed_messages(with_categories=true) %}
    {% if msgs %}
      <div class="mb-4 space-y-2">
        {% for cat, msg in msgs %}
          {% if cat != 'audit' %}
            <div class="
              rounded-md px-3 py-2 text-xs border
              {% if cat=='success' %}bg-emerald-50 border-emerald-200 text-emerald-800
              {% elif cat=='warning' %}bg-amber-50 border-amber-200 text-amber-800
              {% elif cat=='error' %}bg-red-50 border-red-200 text-red-800
              {% else %}bg-slate-100 border-slate-200 text-slate-700{% endif %}
            ">
              {{ msg }}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {# ----------------------- FORM ----------------------- #}
  <form method="post" class="space-y-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    {# Row 1: DATE • CATEGORY • AMOUNT #}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-xs font-medium text-slate-700">Date</label>
        <input type="date"
               name="date"
               value="{{ request.form.get('date') or today_str }}"
               class="mt-1 block w-full rounded-md border border-slate-300 px-3 py-2 text-sm">
      </div>

      <div>
        <div class="flex items-center justify-between">
          <label class="block text-xs font-medium text-slate-700">Category</label>
          <a href="{{ url_for('sms_bp.finance_categories', next='cashbook') }}"
             class="text-xs text-indigo-600 hover:underline">
            Add / edit categories
          </a>
        </div>

        <select name="category_id"
                id="category-select"
                class="mt-1 block w-full rounded-md border border-slate-300 px-3 py-2 text-sm">
          <option value="">Choose category...</option>
          {% for c in categories %}
            <option value="{{ c.id }}"
                    data-kind="{{ c.kind }}"
                    data-fee="{{ '1' if c.is_fee_income else '0' }}"
                    {% if request.form.get('category_id', type=int) == c.id %}selected{% endif %}>
              {{ c.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-xs font-medium text-slate-700">Amount (R)</label>
        <input type="number"
               step="0.01"
               name="amount"
               value="{{ request.form.get('amount','') }}"
               class="mt-1 block w-full rounded-md border border-slate-300 px-3 py-2 text-sm"
               placeholder="e.g. 500 or 500.50">
      </div>
    </div>

    {# Row 2: LEARNER • METHOD • REFERENCE #}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-xs font-medium text-slate-700">
          Learner (fees only)
        </label>

        <select name="learner_id"
                id="learner-select"
                class="mt-1 block w-full rounded-md border border-slate-300 px-3 py-2 text-sm"
                disabled>

          <option value="">Not linked</option>
          {% for l in learners %}
            <option value="{{ l.id }}"
                    {% if request.form.get('learner_id', type=int) == l.id %}selected{% endif %}>
              {{ l.grade }} {{ l.class_code or '' }} – {{ l.last_name }}, {{ l.first_name }}
            </option>
          {% endfor %}
        </select>

        <p class="mt-1 text-[11px] text-slate-500">
          Only required when the category is marked as school fee income.
        </p>
      </div>

      <div>
        <label class="block text-xs font-medium text-slate-700">Method</label>
        <select name="method"
                class="mt-1 block w-full rounded-md border border-slate-300 px-3 py-2 text-sm">
          <option value="">Method…</option>
          <option value="cash"        {% if request.form.get('method') == 'cash' %}selected{% endif %}>Cash</option>
          <option value="eft"         {% if request.form.get('method') == 'eft' %}selected{% endif %}>EFT / bank transfer</option>
          <option value="card"        {% if request.form.get('method') == 'card' %}selected{% endif %}>Card</option>
          <option value="debit-order" {% if request.form.get('method') == 'debit-order' %}selected{% endif %}>Debit order</option>
          <option value="petty-cash"  {% if request.form.get('method') == 'petty-cash' %}selected{% endif %}>Petty cash voucher</option>
          <option value="other"       {% if request.form.get('method') == 'other' %}selected{% endif %}>Other</option>
        </select>
      </div>

      <div>
        <label class="block text-xs font-medium text-slate-700">
          Bank / receipt ref
        </label>
        <input type="text"
               name="bank_ref"
               value="{{ request.form.get('bank_ref','') }}"
               class="mt-1 block w-full rounded-md border border-slate-300 px-3 py-2 text-sm"
               placeholder="receipt no. / bank ref">
        <p class="mt-1 text-[11px] text-slate-500">
          For cash: receipt or voucher number. For EFT: bank statement reference.
        </p>
      </div>
    </div>

    <div class="flex justify-end pt-2">
      <button type="submit"
              class="inline-flex items-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-700">
        Add transaction
      </button>
    </div>
  </form>

  {# ----------------------- TABLE ----------------------- #}
  <div class="mt-6">
    {% if transactions %}
      <table class="min-w-full text-sm">
        <thead>
          <tr class="border-b border-slate-200 text-left text-xs text-slate-500">
            <th class="py-2 pr-4">Date</th>
            <th class="py-2 pr-4">Category</th>
            <th class="py-2 pr-4">Details</th>
            <th class="py-2 text-right">Amount</th>
          </tr>
        </thead>
        <tbody>
          {% for t in transactions %}
            <tr class="border-b border-slate-100">
              <td class="py-2 pr-4 whitespace-nowrap">
                {{ t.date.isoformat() }}
              </td>
              <td class="py-2 pr-4 text-xs">
                {% if t.direction == 'in' %}
                  <span class="text-emerald-600">↑ Income</span>
                {% else %}
                  <span class="text-rose-600">↓ Expense</span>
                {% endif %}
              </td>
              <td class="py-2 pr-4 text-xs">
                {{ t.description or '' }}
              </td>
              <td class="py-2 text-right text-xs">
                R {{ '%.2f' % (t.amount_cents / 100.0) }}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="mt-4 text-sm text-slate-500">
        No transactions captured yet. Use the form above to add your first entry.
      </p>
    {% endif %}
  </div>
</div>

{% endblock %}
