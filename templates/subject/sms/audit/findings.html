{% extends "layout.html" %}
{% block title %}Audit · SMS{% endblock %}

{% block content %}
<div class="mx-auto max-w-5xl mt-8 bg-white shadow rounded-lg p-6">

  <div class="flex items-start justify-between mb-4">
    <div>
      <h1 class="text-lg font-semibold text-slate-900">Audit</h1>
      <p class="text-xs text-slate-500">
        {{ school.short_code or school.name }} · Receipt/voucher sequencing, gaps, and printable audit trail.
      </p>
    </div>

    <a href="{{ url_for('sms_bp.audit_dashboard') }}"
       class="text-xs text-indigo-600 hover:underline">
      ← Back to Audit dashboard
    </a>
  </div>

  {# ---- Summary row ---- #}
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    {% for s in summaries %}
      <div class="rounded-lg border border-slate-200 p-4">
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold text-slate-900">{{ s.label|capitalize }} book</div>
          <div class="text-xs text-slate-500">{{ s.count }} entries</div>
        </div>

        <div class="mt-3 grid grid-cols-2 gap-3 text-xs">
          <div class="rounded-md bg-slate-50 border border-slate-200 p-2">
            <div class="text-slate-500">First</div>
            <div class="font-semibold text-slate-900">{{ s.first if s.first is not none else "—" }}</div>
          </div>
          <div class="rounded-md bg-slate-50 border border-slate-200 p-2">
            <div class="text-slate-500">Last</div>
            <div class="font-semibold text-slate-900">{{ s.last if s.last is not none else "—" }}</div>
          </div>

          <div class="rounded-md bg-amber-50 border border-amber-200 p-2">
            <div class="text-amber-800">Gaps</div>
            <div class="font-semibold text-amber-900">{{ s.gaps }}</div>
          </div>
          <div class="rounded-md bg-rose-50 border border-rose-200 p-2">
            <div class="text-rose-800">Reversals</div>
            <div class="font-semibold text-rose-900">{{ s.reversals }}</div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  {# ---- Findings (the audit trail) ---- #}
  <div class="rounded-lg border border-slate-200">
    <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
      <div class="text-sm font-semibold text-slate-900">Audit findings</div>
      <div class="text-xs text-slate-500">
        Showing newest first · This is what the auditor reviews
      </div>
    </div>

    {% if findings %}
      <div class="divide-y divide-slate-100">
        {% for f in findings %}
          <div class="px-4 py-3">
            <div class="flex items-start justify-between gap-4">
              <div>
                <div class="text-xs text-slate-500">
                  {{ f.date.isoformat() }} · {{ f.label }}
                  {% if f.type == "gap" %}
                    <span class="ml-2 inline-flex items-center rounded-full bg-amber-100 px-2 py-0.5 text-[11px] font-semibold text-amber-800">GAP</span>
                  {% else %}
                    <span class="ml-2 inline-flex items-center rounded-full bg-rose-100 px-2 py-0.5 text-[11px] font-semibold text-rose-800">REVERSAL</span>
                  {% endif %}
                </div>

                <div class="mt-1 text-sm text-slate-900">{{ f.message }}</div>

                <div class="mt-1 text-xs text-slate-500">
                  Current txn #{{ f.txn_id }}
                  {% if f.prev_txn_id %} · Previous txn #{{ f.prev_txn_id }}{% endif %}
                </div>
              </div>

              <div class="text-right">
                {% if f.type == "gap" %}
                  <div class="text-xs font-semibold text-amber-900">
                    {{ f.from_ref }}{% if f.to_ref and f.to_ref != f.from_ref %}–{{ f.to_ref }}{% endif %}
                  </div>
                {% else %}
                  <div class="text-xs font-semibold text-rose-900">
                    {{ f.to_ref }} ≤ {{ f.from_ref }}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="px-4 py-6 text-sm text-slate-500">
        No findings yet. As you capture transactions, gaps/reversals will appear here for the auditor.
      </div>
    {% endif %}
  </div>

  {# ---- Recent refs per book (quick sanity check) ---- #}
  <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
    {% for b in recent_refs %}
      <div class="rounded-lg border border-slate-200 p-4">
        <div class="text-sm font-semibold text-slate-900">
          Recent {{ b.summary.label }} refs
        </div>
        <div class="mt-2 text-xs text-slate-500">
          Last {{ b.recent|length }} numeric refs recorded
        </div>

        <div class="mt-3 space-y-2">
          {% if b.recent %}
            {% for it in b.recent|reverse %}
              <div class="flex items-center justify-between text-xs border border-slate-100 rounded-md px-2 py-1">
                <div class="text-slate-600">{{ it.date.isoformat() }}</div>
                <div class="font-semibold text-slate-900">{{ it.ref }}</div>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-xs text-slate-500">No numeric refs yet.</div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

</div>
{% endblock %}
