{% extends "layout.html" %}
{% block content %}

{% set subject_colors = {
  'home':    'bg-blue-600',
  'reading': 'bg-green-600',
  'loss':    'bg-purple-600',
  'billing': 'bg-orange-600'
} %}

<div class="mx-auto max-w-5xl py-10">

  <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-6 mb-8">
    <div class="flex items-center justify-between mb-2">
      <h1 class="text-2xl font-semibold text-slate-800">Subjects Dashboard</h1>
      <div class="text-sm text-slate-500">Choose a subject to continue.</div>
    </div>

    {% if banner %}
      <div class="mt-4 rounded-lg border border-emerald-300 bg-emerald-50 p-3 text-emerald-800">
        <div class="font-semibold">{{ banner.title }}</div>
        <div class="text-sm">
          {{ banner.detail }}
          {% if banner.amount %} • {{ (banner.amount | int) / 100 }} {{ banner.currency }}{% endif %}
          {% if banner.receipt %} • <a class="underline" href="{{ banner.receipt }}" target="_blank">Receipt</a>{% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    {% for s in subjects %}
      {% set is_admin    = (s.access_level == 'admin') %}
      {% set is_enrolled = (s.access_level == 'enrolled') %}
      {% set is_locked   = (s.access_level == 'locked') %}
      {% set color_bar   = subject_colors.get(s.slug, 'bg-slate-600') %}

      {# ----- compute primary action href per subject ----- #}
      {% if is_admin %}
        {% if s.slug in ('admin', 'admin-general') or s.name|lower == 'admin general' %}
          {# SPECIAL: Admin General goes to tools hub #}
          {% set primary_href = url_for('general_bp.index') %}
          
        {% else %}
          {% set primary_href = url_for('admin_bp.subject_dashboard', subject=s.slug) %}
        {% endif %}
      {% elif is_enrolled %}
        {% set primary_href = url_for('auth_bp.learner_subject_dashboard', subject=s.slug) %}
      {% else %}
        {% set primary_href = None %}
      {% endif %}

      <div class="rounded-xl border bg-white shadow-sm hover:shadow transition overflow-hidden">
        <div class="h-2 {{ color_bar }}"></div>

        <div class="p-6">
          <div class="flex items-start justify-between">
            <h2 class="text-lg font-medium">{{ s.name }}</h2>

            {% if is_admin %}
              <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-200">Admin</span>
            {% elif is_enrolled %}
              <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200">Enrolled</span>
            {% else %}
              <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-slate-50 text-slate-600 border border-slate-200">Locked</span>
            {% endif %}
          </div>

          <p class="mt-2 text-sm text-slate-500">
            {% if is_admin %}
              Manage content, settings, and reports for {{ s.name }}.
            {% elif is_enrolled %}
              Continue your learning in {{ s.name }}.
            {% else %}
              You’re not registered for {{ s.name }}.
            {% endif %}
          </p>

          {# tiny hint badge only for Admin General #}
          {% if is_admin and (s.slug in ('admin', 'admin-general') or s.name|lower == 'admin general') %}
            <div class="mt-3">
              <span class="inline-flex items-center rounded-md bg-slate-100 px-2 py-1 text-xs text-slate-700">
                Tools: TTS
              </span>
            </div>
          {% endif %}

          <div class="mt-5 flex items-center gap-3">
            {% if primary_href %}
              <a href="{{ primary_href }}"
                 class="inline-flex items-center rounded-lg px-3 py-2 text-sm font-medium border bg-white hover:bg-slate-50">
                 {% if is_admin %}Open Admin{% else %}Open Course{% endif %}
              </a>
            {% else %}
              <button type="button"
                      class="inline-flex items-center rounded-lg px-3 py-2 text-sm font-medium border bg-white text-slate-400 cursor-not-allowed"
                      disabled>Locked</button>
            {% endif %}

            <a href="{{ url_for('auth_bp.dashboard_info', subject=s.slug) if is_locked else '#' }}"
               class="text-sm text-slate-500 hover:text-slate-700 {% if not is_locked %}pointer-events-none opacity-40{% endif %}">
              {% if is_locked %}Why locked?{% else %}&nbsp;{% endif %}
            </a>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

{% endblock %}
