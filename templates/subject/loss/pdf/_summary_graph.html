{# ---------- Pull P1..P4 safely from dicts only ---------- #}
{% set P1 = 0 %}{% set P2 = 0 %}{% set P3 = 0 %}{% set P4 = 0 %}

{% if loss_result_percents is defined and loss_result_percents and loss_result_percents.get is defined %}
  {% if loss_result_percents.get('P1') is not none %}
    {% set P1 = loss_result_percents.get('P1')|int %}
  {% elif loss_result_percents.get('phase_1') is not none %}
    {% set P1 = loss_result_percents.get('phase_1')|int %}
  {% endif %}
  {% if loss_result_percents.get('P2') is not none %}
    {% set P2 = loss_result_percents.get('P2')|int %}
  {% elif loss_result_percents.get('phase_2') is not none %}
    {% set P2 = loss_result_percents.get('phase_2')|int %}
  {% endif %}
  {% if loss_result_percents.get('P3') is not none %}
    {% set P3 = loss_result_percents.get('P3')|int %}
  {% elif loss_result_percents.get('phase_3') is not none %}
    {% set P3 = loss_result_percents.get('phase_3')|int %}
  {% endif %}
  {% if loss_result_percents.get('P4') is not none %}
    {% set P4 = loss_result_percents.get('P4')|int %}
  {% elif loss_result_percents.get('phase_4') is not none %}
    {% set P4 = loss_result_percents.get('phase_4')|int %}
  {% endif %}
{% elif phase_scores_pct is defined and phase_scores_pct and phase_scores_pct.get is defined %}
  {% if phase_scores_pct.get('P1') is not none %}
    {% set P1 = phase_scores_pct.get('P1')|int %}
  {% elif phase_scores_pct.get('phase_1') is not none %}
    {% set P1 = phase_scores_pct.get('phase_1')|int %}
  {% endif %}
  {% if phase_scores_pct.get('P2') is not none %}
    {% set P2 = phase_scores_pct.get('P2')|int %}
  {% elif phase_scores_pct.get('phase_2') is not none %}
    {% set P2 = phase_scores_pct.get('phase_2')|int %}
  {% endif %}
  {% if phase_scores_pct.get('P3') is not none %}
    {% set P3 = phase_scores_pct.get('P3')|int %}
  {% elif phase_scores_pct.get('phase_3') is not none %}
    {% set P3 = phase_scores_pct.get('phase_3')|int %}
  {% endif %}
  {% if phase_scores_pct.get('P4') is not none %}
    {% set P4 = phase_scores_pct.get('P4')|int %}
  {% elif phase_scores_pct.get('phase_4') is not none %}
    {% set P4 = phase_scores_pct.get('phase_4')|int %}
  {% endif %}
{% endif %}

{# Clamp to 0..100 #}
{% if P1 < 0 %}{% set P1 = 0 %}{% elif P1 > 100 %}{% set P1 = 100 %}{% endif %}
{% if P2 < 0 %}{% set P2 = 0 %}{% elif P2 > 100 %}{% set P2 = 100 %}{% endif %}
{% if P3 < 0 %}{% set P3 = 0 %}{% elif P3 > 100 %}{% set P3 = 100 %}{% endif %}
{% if P4 < 0 %}{% set P4 = 0 %}{% elif P4 > 100 %}{% set P4 = 100 %}{% endif %}

{# Convert to 10 stacked levels (no CSS) #}
{% set H1 = ((P1 + 5) // 10) %}{% if H1 < 0 %}{% set H1 = 0 %}{% elif H1 > 10 %}{% set H1 = 10 %}{% endif %}
{% set H2 = ((P2 + 5) // 10) %}{% if H2 < 0 %}{% set H2 = 0 %}{% elif H2 > 10 %}{% set H2 = 10 %}{% endif %}
{% set H3 = ((P3 + 5) // 10) %}{% if H3 < 0 %}{% set H3 = 0 %}{% elif H3 > 10 %}{% set H3 = 10 %}{% endif %}
{% set H4 = ((P4 + 5) // 10) %}{% if H4 < 0 %}{% set H4 = 0 %}{% elif H4 > 10 %}{% set H4 = 10 %}{% endif %}

{# Colors (hex works in xhtml2pdf/Weasy) #}
{% set C1 = '#3b82f6' %}{% set C2 = '#22c55e' %}{% set C3 = '#f59e0b' %}{% set C4 = '#ef4444' %}
{% set CBG = '#e5e7eb' %}

{# ----------------- Summary text ----------------- #}
<table border="0" cellpadding="0" cellspacing="0" width="100%">
  <tr><td><b>Phase Summary</b></td></tr>
  <tr><td><font size="2">You are experiencing these feelings as shown under Comments in these phases</font></td></tr>
</table>
<table border="0" cellpadding="2" cellspacing="0" width="100%">
  <tr><td>• Phase 1: Impact: {{ P1 }}% of the time.</td></tr>
  <tr><td>• Phase 2: Hopelessness: {{ P2 }}% of the time.</td></tr>
  <tr><td>• Phase 3: Helplessness: {{ P3 }}% of the time.</td></tr>
  <tr><td>• Phase 4: Re-Engagement: {{ P4 }}% of the time.</td></tr>
</table>

{# ----------------- Vertical bar chart ----------------- #}
<table border="0" cellpadding="6" cellspacing="0" width="100%" style="margin-top:6px;">
  <tr><td><b>Phase Graph (%)</b></td></tr>
</table>

{% if (P1 + P2 + P3 + P4) == 0 %}
  <table border="0" cellpadding="0" cellspacing="0" width="100%">
    <tr><td><font size="2">No graph data.</font></td></tr>
  </table>
{% else %}
  <table border="0" cellpadding="0" cellspacing="2" align="left">
    {# 10 rows high, fill from bottom #}
    {% for level in range(10, 0, -1) %}
      <tr>
        <td width="48" height="12" bgcolor="{{ C1 if H1 >= level else CBG }}"></td>
        <td width="48" height="12" bgcolor="{{ C2 if H2 >= level else CBG }}"></td>
        <td width="48" height="12" bgcolor="{{ C3 if H3 >= level else CBG }}"></td>
        <td width="48" height="12" bgcolor="{{ C4 if H4 >= level else CBG }}"></td>
      </tr>
    {% endfor %}
    <tr>
      <td align="center"><font size="2">Impact</font></td>
      <td align="center"><font size="2">Hopeless</font></td>
      <td align="center"><font size="2">Helpless</font></td>
      <td align="center"><font size="2">Re-Engage</font></td>
    </tr>
    <tr>
      <td align="center"><font size="2">{{ P1 }}%</font></td>
      <td align="center"><font size="2">{{ P2 }}%</font></td>
      <td align="center"><font size="2">{{ P3 }}%</font></td>
      <td align="center"><font size="2">{{ P4 }}%</font></td>
    </tr>
  </table>
{% endif %}
