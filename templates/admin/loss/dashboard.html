{% extends "layout.html" %}
{% block title %}LOSS — Admin{% endblock %}

{% block content %}

<div class="mx-auto w-full max-w-4xl px-6 py-8">
  <div class="rounded-2xl border bg-white shadow-sm overflow-hidden">
    <!-- bridge strip -->
    <div style="height:6px; background:linear-gradient(90deg,#0ea5e9,#6366f1,#22c55e);"></div>

    <div class="p-6">
      <!-- Header -->
      <div class="mb-6 flex items-center justify-between">
        <a href="{{ url_for('auth_bp.bridge_dashboard') }}"
           class="inline-flex items-center gap-2 rounded border bg-white px-3 py-1.5 text-sm hover:bg-slate-50">
          ← Back
        </a>
        <h1 class="text-xl font-semibold">LOSS — Admin</h1>
        <div></div>
      </div>

      <!-- Controls -->
      <div class="rounded-xl border bg-white p-5 shadow-sm">
        <form method="get"
              action="{{ url_for('admin_bp.loss_index') }}"
              class="grid grid-cols-1 gap-3 md:grid-cols-12 md:items-end">
          <!-- User select -->
          <div class="md:col-span-6">
            <label class="block text-sm text-slate-600 mb-1">User</label>
            <select name="user_id" class="w-full rounded border px-2 py-1.5 text-sm">
              <option value="">— select a user —</option>
              {% for uid_opt in user_ids %}
                <option value="{{ uid_opt }}"
                        {{ 'selected' if user_id is not none and (user_id|string) == (uid_opt|string) else '' }}>
                  User {{ uid_opt }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- Run select -->
          <div class="md:col-span-4">
            <label class="block text-sm text-slate-600 mb-1">Run</label>
            <select name="run_id" class="w-full rounded border px-2 py-1.5 text-sm">
              <option value="">— select a run —</option>
              {% for r in runs %}
                {# r might be an int or a row; normalise to rid #}
                {% set rid = r.id if r.id is defined else r %}
                <option value="{{ rid }}"
                        {{ 'selected' if run_id is not none and (run_id|string) == (rid|string) else '' }}>
                  Run {{ rid }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- Load button -->
          <div class="md:col-span-2">
            <button type="submit"
                    class="w-full rounded bg-slate-800 px-3 py-2 text-sm font-medium text-white hover:bg-slate-900">
              Load
            </button>
          </div>
        </form>

        {% if subject %}
          <p class="mt-3 text-sm text-slate-600">
            Run Subject: <span class="font-semibold">{{ subject }}</span>
          </p>
        {% endif %}
      </div>

      {# status + actions ----------------------------------------------------- #}
      {% set has_user = user_id is not none and user_id != '' %}
      {% set has_run  = run_id is not none and run_id != '' %}
      {% set can_run = has_run %}
      {% set can_report = has_result %}
      {% set disabled_cls = '' if can_run else 'opacity-50 pointer-events-none' %}

      {% if can_run %}
        <div class="mt-4 text-sm text-slate-600">
          Run {{ run_id }} • User {{ user_id if has_user else '—' }}
          {% if subject %} • Subject: {{ subject }}{% endif %}
          • Result: {{ 'Ready' if can_report else 'Pending' }}
        </div>
      {% endif %}

      <!-- Buttons row -->
      <div class="mt-3 flex gap-2">
        <a href="{{ url_for('admin_bp.loss_responses', run_id=run_id) if can_run else '#' }}"
           class="px-3 py-2 rounded border hover:bg-slate-100 {{ disabled_cls }}"
           aria-disabled="{{ 'false' if can_run else 'true' }}">
          Responses
        </a>
        <a href="{{ url_for('admin_bp.tables_view') }}"
           class="px-3 py-2 rounded border hover:bg-slate-100">
          View Tables
        </a>
        <a href="{{ url_for('admin_bp.tables_save') }}"
           class="px-3 py-2 rounded border hover:bg-slate-100">
          Save Tables
        </a>
      </div>

    </div>
  </div>
</div>

{% endblock %}
