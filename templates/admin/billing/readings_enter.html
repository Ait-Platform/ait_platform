{% extends "layout.html" %}
{% block content %}
<div class="container mx-auto py-10 max-w-5xl">
  <h1 class="text-2xl font-semibold mb-6">Enter Reading</h1>
    <div class="mb-4 print:hidden">
      <a href="{{ url_for('admin_bp.readings_dashboard') }}"
        class="inline-flex items-center gap-2 rounded border px-3 py-1.5 hover:bg-slate-50">
        <span aria-hidden="true">←</span><span>Back</span>
      </a>
    </div>

  <!-- Tenant select -->
  <form method="GET" action="{{ url_for('admin_bp.readings_enter') }}" class="mb-6">
    <label class="block text-sm mb-1">Tenant</label>
    <div class="flex gap-3">
      <select name="tenant_id" class="border rounded p-2 w-full" required onchange="this.form.submit()">
        <option value="">Select a tenant…</option>
        {% for t in tenants %}
          <option value="{{ t.id }}" {{ tenant and t.id == tenant.id and 'selected' or '' }}>
            {{ t.name }}{% if t.unit_label %} — Unit {{ t.unit_label }}{% endif %}
          </option>
        {% endfor %}
      </select>
      <noscript><button class="px-4 py-2 rounded bg-black text-white">Go</button></noscript>
    </div>
  </form>

  {% if tenant %}
    <div class="mb-6 inline-flex items-center gap-2 rounded-full bg-slate-100 px-4 py-2 text-sm">
      <span class="font-medium">{{ tenant.name }}</span>
      {% if tenant.unit_label %}<span class="text-slate-600">— Unit {{ tenant.unit_label }}</span>{% endif %}
    </div>

    <form method="POST" action="{{ url_for('admin_bp.readings_enter') }}" class="grid md:grid-cols-4 gap-4">
      <input type="hidden" name="tenant_id" value="{{ tenant.id }}">
      <div class="md:col-span-2">
        <label class="block text-sm mb-1">Meter</label>
        <select name="meter_id" class="w-full border rounded p-2" required>
          {% for m in meters %}
            <option value="{{ m.id }}">
              {{ m.meter_number or m.display_name or ('Meter #' ~ m.id) }}
            </option>
          {% endfor %}
        </select>
        {% if not meters %}
          <p class="text-sm text-red-600 mt-2">No meters found for this tenant.</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm mb-1">Reading Date</label>
        <input type="date" name="reading_date" class="w-full border rounded p-2" required>
      </div>
      <div>
        <label class="block text-sm mb-1">Reading Value</label>
        <input type="number" step="0.001" name="reading_value" class="w-full border rounded p-2" required>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      </div>

      {% if warning_same %}
        <div class="md:col-span-4 rounded border border-amber-300 bg-amber-50 p-4">
          <p class="text-sm">{{ warning_same.message }}</p>
          <div class="mt-3 flex gap-3">
            <button name="confirm_same" value="1" class="px-4 py-2 rounded bg-black text-white">Yes, accept</button>
            <a href="{{ url_for('admin_bp.readings_enter', tenant_id=tenant.id) }}"
              class="px-4 py-2 rounded border">No, cancel</a>
          </div>
        </div>
      {% else %}
        <div class="md:col-span-4">
          <button class="px-4 py-2 rounded bg-black text-white" {% if not meters %}disabled{% endif %}>
            Save Reading
          </button>
        </div>
      {% endif %}
    </form>

    {% if prev_info %}
      <div class="mt-6 text-sm text-slate-600">
        Previous month reference: {{ prev_info.reading_value }} on {{ prev_info.reading_date }}.
      </div>
    {% endif %}
  {% endif %}
</div>
{% endblock %}

