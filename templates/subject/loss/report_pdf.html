{# templates/subject/loss/report.html #}
{% extends "layout.html" %}
{% import "subject/loss/pdf/_macros.html" as M %}

{% block title %}Loss Results | AIT{% endblock %}

{% block content %}
  {# ---- Context & safe defaults ---- #}
  {% set phase_labels = {1:'Impact', 2:'Hopelessness', 3:'Helplessness', 4:'Re-Engagement'} %}
  {% set blocks = phase_blocks | default([], true) %}
  {% set oa = overall_assessment | default(None) %}
  {% set viewer_is_admin = viewer_is_admin | default(false) %}

  {# Learner/display name #}
  {% set learner_name = (
    user.display_name if user is defined and user and user.display_name
    else (user.full_name if user and user.full_name
    else (user.email if user and user.email else 'Learner'))
  ) %}

  {# Date label (created_at preferred, else started_at) #}
  {% set dt_label = created_at if created_at is defined and created_at
                    else (started_at if started_at is defined else None) %}

  {# Extract P1..P4 safely from per-phase blocks, fallback to result.* #}
  {% set ns = namespace(P1=None, P2=None, P3=None, P4=None) %}
  {% for b in blocks %}
    {% set v = (b.pct if b.pct is defined else (b.width_pct if b.width_pct is defined else 0)) | int %}
    {% if b.phase == 1 %}{% set ns.P1 = v %}{% endif %}
    {% if b.phase == 2 %}{% set ns.P2 = v %}{% endif %}
    {% if b.phase == 3 %}{% set ns.P3 = v %}{% endif %}
    {% if b.phase == 4 %}{% set ns.P4 = v %}{% endif %}
  {% endfor %}

  {% set P1 = (ns.P1 if ns.P1 is not none else (result.phase_1 if result is defined and result else 0)) | int %}
  {% set P2 = (ns.P2 if ns.P2 is not none else (result.phase_2 if result is defined and result else 0)) | int %}
  {% set P3 = (ns.P3 if ns.P3 is not none else (result.phase_3 if result is defined and result else 0)) | int %}
  {% set P4 = (ns.P4 if ns.P4 is not none else (result.phase_4 if result is defined and result else 0)) | int %}
  {% set total = (result.total if result is defined and result and result.total is not none else (P1 + P2 + P3 + P4)) | int %}

  <div class="mx-auto w-full max-w-6xl px-6 pb-10">

    {# Shared chip / bar styles #}
    {% include "subject/loss/pdf/_styles.html" %}

    {# Top bar with Exit card #}
    <div class="py-6">
      <div class="relative">
        <div class="pr-0 md:pr-[360px]">
          <h1 class="text-2xl font-semibold text-slate-900">Assessment Results</h1>
          <p class="mt-1 text-sm text-slate-600">
            Summary of your Loss of a Loved One (LOLO) assessment.
          </p>
        </div>

        <div class="mt-4 md:mt-0 md:absolute md:top-0 md:right-0 md:w-[340px]">
          <div class="rounded-2xl border border-slate-200 bg-white shadow-sm">
            <div class="h-1.5 w-full rounded-t-2xl bg-blue-600"></div>
            <div class="p-4">
              <p class="text-[15px] leading-5 text-slate-700">
                Press <span class="font-semibold">Exit</span> to go to the finish page where you can
                <span class="font-medium">email / save / print</span> your report. Your session will end afterwards.
              </p>
              <a href="{{ url_for('loss_bp.report_exit', run_id=run_id, user_id=user_id) }}"
                 class="mt-3 inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white hover:bg-blue-700 focus:outline-none">
                Exit
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    {# Header block (name, email, run, date) #}
    <div class="mb-6">
      {% include "subject/loss/pdf/_header.html" %}
    </div>

    {% if blocks|length == 0 %}
      <div class="rounded-xl border border-amber-200 p-4 bg-amber-50 text-amber-800">
        No phase data available for this run.
      </div>
    {% endif %}

    {# ---------- Per-phase sections ---------- #}
    <div class="space-y-5">
      {% for blk in blocks %}
        {% set pct  = (blk.pct if blk.pct is defined else (blk.width_pct if blk.width_pct is defined else 0)) | int %}
        {% set band = blk.band if blk.band is defined else (3 if pct>=70 else (2 if pct>=40 else 1)) %}
        {% set range_label = 'High' if band==3 else ('Medium' if band==2 else 'Low') %}

        {% if blk.phase in [1,2,3] %}
          {% set av_txt     = 'Not Coping' if band==3 else ('Slightly Coping' if band==2 else 'Coping') %}
          {% set range_chip = 'chip-emerald' if band==1 else ('chip-amber' if band==2 else 'chip-rose') %}
          {% set bar_color  = 'bar-emerald' if band==1 else ('bar-amber' if band==2 else 'bar-rose') %}
          {% set palette    = 'rose' if band==3 else ('amber' if band==2 else 'emerald') %}
        {% else %}
          {% set av_txt     = 'Coping' if band==3 else ('Slightly Coping' if band==2 else 'Not Coping') %}
          {% set range_chip = 'chip-blue' if band==1 else ('chip-lightemerald' if band==2 else 'chip-emerald') %}
          {% set bar_color  = 'bar-blue' if band==1 else ('bar-mint' if band==2 else 'bar-emerald') %}
          {% set palette    = 'emerald' if band==3 else ('mint' if band==2 else 'blue') %}
        {% endif %}

        {% set av_chip = 'chip-av-coping' if av_txt=='Coping'
                         else ('chip-av-slightlycoping' if av_txt=='Slightly Coping' else 'chip-av-notcoping') %}

        <section class="phase-card rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
          {% include "subject/loss/pdf/_phase_heading.html" %}
          {% include "subject/loss/pdf/_hbar_safe.html" %}
          {% include "subject/loss/pdf/_phase_body.html" %}
          {% include "subject/loss/pdf/_progress.html" %}
        </section>
      {% endfor %}
    </div>

    {# ---------- Phase Summary ---------- #}
    <section class="mt-6 rounded-2xl border border-slate-200 bg-white shadow-sm">
      <div class="h-1.5 w-full rounded-t-2xl bg-blue-600"></div>
      <div class="p-5">
        {% include "subject/loss/pdf/_summary.html" %}
      </div>
    </section>

    {# ---------- Overall Assessment (card) ---------- #}
    <section class="mt-6 rounded-2xl border border-slate-200 bg-white shadow-sm">
      <div class="h-1.5 w-full rounded-t-2xl bg-blue-600"></div>
      <div class="p-5">
        {% include "subject/loss/pdf/_overall_assessment.html" %}
      </div>
    </section>

    {# ---------- Donation card ---------- #}
    <section class="mt-6 rounded-2xl border border-slate-200 bg-white shadow-sm">
      <div class="h-1.5 w-full rounded-t-2xl bg-emerald-600"></div>
      <div class="p-5">
        {% include "subject/loss/pdf/_donation_bank_details.html" %}
      </div>
    </section>

    {# ---------- Disclaimer card ---------- #}
    <section class="mt-6 rounded-2xl border border-slate-200 bg-white shadow-sm mb-6">
      <div class="h-1.5 w-full rounded-t-2xl bg-slate-500"></div>
      <div class="p-5">
        {% include "subject/loss/pdf/_disclaimer.html" %}
      </div>
    </section>

  </div>
{% endblock %}
