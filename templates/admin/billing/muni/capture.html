{% extends "layout.html" %}
{% block content %}

<div class="container mx-auto py-10 space-y-6">

  <h1 class="text-2xl font-semibold">
    Municipal Capture — <span class="font-mono">{{ account_number }}</span>
  </h1>

  <!-- Action bar -->
  <div class="rounded-xl border p-3">
    <div class="flex flex-wrap items-center gap-3">
      <!-- Back to picker -->
      <a href="{{ url_for('admin_bp.muni_accounts') }}"
         class="px-3 py-2 rounded-lg border">Back to Admin</a>

      <!-- Ledger view (has its own back-to-capture) -->
      <a href="{{ url_for('admin_bp.muni_ledger', account_number=account_number) }}"
         class="px-3 py-2 rounded-lg border">Open Ledger View</a>

      <!-- Exports hub, remember where we came from -->
      <a href="{{ url_for('admin_bp.muni_exports_hub', back=account_number) }}"
         class="px-3 py-2 rounded-lg bg-black text-white">Exports & Prints</a>
    </div>
  </div>

  <!-- Two-column forms -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Monthly totals -->
    <form method="post" class="rounded-xl border p-6 space-y-4">
      <input type="hidden" name="form_kind" value="totals">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <h2 class="font-medium">Monthly Totals (Captured)</h2>

      <label class="text-sm block">
        Period
        <input name="period" type="month"
               value="{{ current_period or '' }}"
               class="mt-1 border rounded-lg p-2 w-48 font-mono" required>
      </label>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <label class="text-sm block">
          Balance
          <input name="balance" type="number" step="0.01"
                 class="mt-1 border rounded-lg p-2 w-full">
        </label>
        <label class="text-sm block">
          Due
          <input name="due" type="number" step="0.01"
                 class="mt-1 border rounded-lg p-2 w-full">
        </label>
        <label class="text-sm block">
          Paid
          <input name="paid" type="number" step="0.01"
                 class="mt-1 border rounded-lg p-2 w-full">
        </label>
        <label class="text-sm block">
          Arrears
          <input name="arrears" type="number" step="0.01"
                 class="mt-1 border rounded-lg p-2 w-full">
        </label>
      </div>

      <button class="px-4 py-2 rounded-lg bg-black text-white">Save Totals</button>
    </form>

    <!-- METSOA due -->
    <form method="post" class="rounded-xl border p-6 space-y-4">
      <input type="hidden" name="form_kind" value="metsoa">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <h2 class="font-medium">METSOA — Due to Metro</h2>

      <label class="text-sm block">
        Period
        <input name="period" type="month"
               value="{{ current_period or '' }}"
               class="mt-1 border rounded-lg p-2 w-48 font-mono" required>
      </label>

      <label class="text-sm block">
        Metro Due (METSOA)
        <input name="metsoa_due" type="number" step="0.01"
               class="mt-1 border rounded-lg p-2 w-full">
      </label>

      <button class="px-4 py-2 rounded-lg bg-black text-white">Save METSOA</button>
    </form>
  </div>

  <!-- Data cards -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Ledger table -->
    <div class="rounded-xl border overflow-hidden">
      <div class="px-4 py-3 font-medium bg-slate-50">Ledger (Captured)</div>
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left">
            <th class="px-4 py-2">Period</th>
            <th class="px-4 py-2">Balance</th>
            <th class="px-4 py-2">Due</th>
            <th class="px-4 py-2">Paid</th>
            <th class="px-4 py-2">Arrears</th>
          </tr>
        </thead>
        <tbody>
          {% for r in ledger %}
          <tr class="border-t">
            <td class="px-4 py-2 font-mono">{{ r.period }}</td>
            <td class="px-4 py-2">{{ '%.2f'|format(r.balance or 0) }}</td>
            <td class="px-4 py-2">{{ '%.2f'|format(r.due or 0) }}</td>
            <td class="px-4 py-2">{{ '%.2f'|format(r.paid or 0) }}</td>
            <td class="px-4 py-2">{{ '%.2f'|format(r.arrears or 0) }}</td>
          </tr>
          {% else %}
          <tr class="border-t">
            <td class="px-4 py-6 text-center text-slate-500" colspan="5">No ledger rows yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Recon table -->
    <div class="rounded-xl border overflow-hidden">
      <div class="px-4 py-3 font-medium bg-slate-50">Recon — Your Due vs METSOA</div>
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left">
            <th class="px-4 py-2">Period</th>
            <th class="px-4 py-2">Your Due</th>
            <th class="px-4 py-2">METSOA</th>
            <th class="px-4 py-2">Diff</th>
          </tr>
        </thead>
        <tbody>
          {% for r in recon %}
          <tr class="border-t">
            <td class="px-4 py-2 font-mono">{{ r.period }}</td>
            <td class="px-4 py-2">{{ '%.2f'|format(r.system_due or 0) }}</td>
            <td class="px-4 py-2">{{ '%.2f'|format(r.metro_due or 0) }}</td>
            <td class="px-4 py-2 {% if (r.diff or 0) < 0 %}text-red-600{% elif (r.diff or 0) > 0 %}text-emerald-600{% endif %}">
              {{ '%.2f'|format(r.diff or 0) }}
            </td>
          </tr>
          {% else %}
          <tr class="border-t">
            <td class="px-4 py-6 text-center text-slate-500" colspan="4">No recon rows yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

{% endblock %}
