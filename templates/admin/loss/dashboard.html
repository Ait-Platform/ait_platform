{% extends "layout.html" %}
{% block title %}LOSS — Admin{% endblock %}

{% block content %}

<div class="mx-auto w-full max-w-4xl px-6 py-8">
  <div class="rounded-2xl border bg-white shadow-sm overflow-hidden">
    <!-- bridge strip -->
    <div style="height:6px; background:linear-gradient(90deg,#0ea5e9,#6366f1,#22c55e);"></div>

    <div class="p-6">
      <!-- Header -->
      <div class="mb-6 flex items-center justify-between">
        <a href="{{ url_for('auth_bp.bridge_dashboard') }}"
           class="inline-flex items-center gap-2 rounded border bg-white px-3 py-1.5 text-sm hover:bg-slate-50">
          ← Back
        </a>
        <h1 class="text-xl font-semibold">LOSS — Admin</h1>
        <div></div>
      </div>

      <!-- Controls -->
      <div class="rounded-xl border bg-white p-5 shadow-sm">
        <form method="get"
              action="{{ url_for('admin_bp.loss_index') }}"
              class="grid grid-cols-1 gap-3 md:grid-cols-12 md:items-end">

          <!-- Run select (primary driver) -->
          <div class="md:col-span-8">
            <label class="block text-sm text-slate-600 mb-1">Run</label>
            <select name="run_id"
                    class="w-full rounded border px-2 py-1.5 text-sm"
                    onchange="this.form.submit()">
              <option value="">— select a run —</option>
              {% for r in runs %}
                {# r might be an int or a row; normalise to rid #}
                {% set rid = r.id if r.id is defined else r %}
                <option value="{{ rid }}"
                        {{ 'selected' if run_id is not none and (run_id|string) == (rid|string) else '' }}>
                  Run {{ rid }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- Spacer / info -->
          <div class="md:col-span-4 text-xs text-slate-500">
            Select a run to see its user and open the responses/report tools.
          </div>
        </form>

        {% if subject %}
          <p class="mt-3 text-sm text-slate-600">
            Run subject: <span class="font-semibold">{{ subject }}</span>
          </p>
        {% endif %}

        {# Optional: show user nicely if you pass user_label / user_email / user_id #}
        {% if user_id or user_label or user_email %}
          <p class="mt-1 text-sm text-slate-600">
            User:
            <span class="font-semibold">
              {# prefer a friendly label if you provide one from the view #}
              {% if user_label %}
                {{ user_label }}
              {% elif user_email %}
                {{ user_email }} (ID {{ user_id }})
              {% elif user_id %}
                User {{ user_id }}
              {% else %}
                —
              {% endif %}
            </span>
          </p>
        {% endif %}
      </div>

      {# status + actions ----------------------------------------------------- #}
      {% set has_user = user_id is not none and user_id != '' %}
      {% set has_run  = run_id is not none and run_id != '' %}
      {% set can_run = has_run %}
      {% set can_report = has_result %}
      {% set disabled_cls = '' if can_run else 'opacity-50 pointer-events-none' %}

      {% if can_run %}
        <div class="mt-4 text-sm text-slate-600">
          Run {{ run_id }}
          {% if has_user or user_label or user_email %}
            • User:
            {% if user_label %}
              {{ user_label }}
            {% elif user_email %}
              {{ user_email }} (ID {{ user_id }})
            {% elif user_id %}
              User {{ user_id }}
            {% else %}
              —
            {% endif %}
          {% endif %}
          {% if subject %} • Subject: {{ subject }}{% endif %}
          • Result: {{ 'Ready' if can_report else 'Pending' }}
        </div>
      {% endif %}

      <!-- Buttons row -->
      <div class="mt-3 flex flex-wrap gap-2">
        <a href="{{ url_for('admin_bp.loss_responses', run_id=run_id) if can_run else '#' }}"
           class="px-3 py-2 rounded border hover:bg-slate-100 {{ disabled_cls }}"
           aria-disabled="{{ 'false' if can_run else 'true' }}">
          Responses
        </a>
        <a href="{{ url_for('admin_bp.tables_view') }}"
           class="px-3 py-2 rounded border hover:bg-slate-100">
          View Tables
        </a>
        <a href="{{ url_for('admin_bp.tables_save') }}"
           class="px-3 py-2 rounded border hover:bg-slate-100">
          Save Tables
        </a>
      </div>

    </div>
  </div>
</div>

{% endblock %}
