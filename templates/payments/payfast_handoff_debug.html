{% extends "layout.html" %}
{% block title %}PayFast · Handoff (Debug){% endblock %}

{% block content %}
<div class="mx-auto max-w-2xl mt-10 bg-white p-6 rounded shadow">

  <h1 class="text-xl font-semibold mb-2">PayFast handoff (debug)</h1>
  <div class="text-sm text-slate-600 mb-4">
    Endpoint:
    <span class="font-mono">{{ payfast_url }}</span>
    · Mode:
    <span class="inline-block px-2 py-0.5 rounded bg-slate-100 border">
      {{ 'Sandbox' if 'sandbox' in (payfast_url or '') else 'Live' }}
    </span>
  </div>

  <div class="rounded border bg-slate-50 p-3">
    <div class="text-sm font-medium mb-2">Fields to be sent</div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="text-left">
          <tr>
            <th class="py-1 pr-3">Key</th>
            <th class="py-1">Value</th>
          </tr>
        </thead>
        <tbody class="align-top">
          {% for k, v in (pf_data or {}).items()|sort %}
          <tr class="border-t">
            <td class="py-1 pr-3 font-mono text-xs whitespace-nowrap">{{ k }}</td>
            <td class="py-1 font-mono text-xs break-all">{{ v }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <form class="mt-4" method="post" action="{{ payfast_url }}">
    {% for k, v in (pf_data or {}).items() %}
      <input type="hidden" name="{{ k }}" value="{{ v }}">
    {% endfor %}
    <div class="flex items-center gap-2">
      <button class="rounded bg-blue-600 px-4 py-2 text-white font-semibold hover:bg-blue-700" type="submit">
        Open PayFast
      </button>
      <a href="{{ request.url }}{% if '?' in request.url %}&{% else %}?{% endif %}auto=1"
         class="text-sm underline">Auto-submit</a>
    </div>
  </form>

  <details class="mt-4">
    <summary class="cursor-pointer text-sm text-slate-600">Show raw JSON</summary>
    <pre class="mt-2 text-xs bg-black text-white p-3 rounded overflow-x-auto">{{ pf_data|tojson(indent=2) }}</pre>
  </details>

  <p class="mt-4 text-xs text-slate-500">
    Tip: Sandbox merchant <code class="font-mono">10000100</code> does not require a signature. Live merchant requires
    a valid signature and HTTPS return/cancel/notify URLs.
  </p>
</div>

{% if request.args.get('auto') in ('1','true','yes') %}
<script>
  // Auto-submit after a tick so the page renders first
  window.addEventListener('DOMContentLoaded', () => {
    document.querySelector('form[method="post"][action="{{ payfast_url }}"]').submit();
  });
</script>
{% endif %}
{% endblock %}
