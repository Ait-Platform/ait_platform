{% extends "layout.html" %}
{% block title %}Pricing · Admin · AIT{% endblock %}

{% block content %}
<div class="mx-auto max-w-4xl py-8">

  <!-- Header -->
  <div class="flex items-center justify-between mb-4">
    <div>
      <h1 class="text-xl font-semibold text-slate-800">
        Pricing for {{ subject.name }}
      </h1>
      <p class="text-sm text-slate-500">
        Manage parity tiers per subject.
      </p>
    </div>

    <a href="/admin/general/"
       class="rounded-lg border px-3 py-1.5 text-sm hover:bg-slate-50">
      ← Back to Admin
    </a>
  </div>

  <!-- Subject switcher -->
  <form method="get" class="mb-4">
    <label class="text-sm text-slate-600 mr-2">Subject:</label>
    <select name="subject"
            class="rounded border px-2 py-1 text-sm"
            onchange="this.form.submit()">
      {% for s in all_subjects %}
        <option value="{{ s.slug }}" {% if s.id == subject.id %}selected{% endif %}>
          {{ s.name }}
        </option>
      {% endfor %}
    </select>
  </form>

  <!-- Anchor info -->
  {% if anchor_zar_cents %}
    <div class="mb-4 text-sm text-slate-600">
      ZAR anchor for {{ subject.name }}:
      <span class="font-semibold">
        {{ anchor_zar_cents }} cents (R {{ '%.2f' % (anchor_zar_cents / 100.0) }})
      </span>
      <span class="text-slate-500 ml-1">
        (You can still override local amounts per country.)
      </span>
    </div>
  {% else %}
    <div class="mb-4 text-sm text-red-600">
      No base price found in auth_pricing for this subject. Add that first.
    </div>
  {% endif %}

  <!-- Add country tier -->
  {% if anchor_zar_cents %}
    <form method="post"
          class="mb-6 rounded-lg border border-slate-200 bg-white p-4 flex flex-col gap-3">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <div class="text-sm font-semibold text-slate-800 mb-2">
        Add country tier
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">

        <!-- Country -->
        <div>
          <label class="block text-xs font-medium text-slate-500 mb-1">
            Country
          </label>
          <select id="country_select"
                  name="country_code"
                  class="w-full rounded border px-2 py-1 text-sm"
                  required>
            <option value="">Select…</option>
            {% for c in countries %}
              <option value="{{ c.country_code }}"
                      data-fx="{{ c.fx_to_zar }}">
                {{ c.name }} ({{ c.country_code }} · {{ c.currency_code }})
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- FX rate (1 ZAR = ? local) -->
        <div>
          <label class="block text-xs font-medium text-slate-500 mb-1">
            FX rate (1 ZAR = ? local)
          </label>
          <input id="fx_rate"
                 name="fx_rate"
                 type="text"
                 class="w-full rounded border px-2 py-1 text-sm"
                 placeholder="e.g. 0.055">
          <p class="mt-1 text-xs text-slate-500">
            Loaded from reference; adjust if you like.
          </p>
        </div>

        <!-- Local amount (cents) -->
        <div>
          <label class="block text-xs font-medium text-slate-500 mb-1">
            Local amount (cents)
          </label>
          <input id="local_amount_cents"
                 name="local_amount_cents"
                 class="w-full rounded border px-2 py-1 text-sm"
                 placeholder="auto from FX, or type"
                 inputmode="numeric">
          <p id="local_amount_hint"
             class="mt-1 text-xs text-slate-500"></p>
        </div>

        <!-- Save -->
        <div>
          <button type="submit"
                  class="w-full rounded-md bg-slate-800 px-3 py-2 text-sm font-medium text-white hover:bg-slate-900">
            Save tier
          </button>
        </div>

      </div>
    </form>
  {% endif %}

  <!-- Existing tiers -->
  <div class="overflow-x-auto rounded-lg border bg-white">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-50 text-left text-xs font-semibold text-slate-500">
        <tr>
          <th class="px-3 py-2">Country</th>
          <th class="px-3 py-2">Local amount (cents)</th>
          <th class="px-3 py-2">ZAR anchor (cents)</th>
          <th class="px-3 py-2">Active?</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100">
        {% for t in tiers %}
          <tr>
            <td class="px-3 py-2">{{ t.country_code }}</td>
            <td class="px-3 py-2">{{ t.local_amount_cents }}</td>
            <td class="px-3 py-2">{{ t.zar_amount_cents }}</td>
            <td class="px-3 py-2">
              {% if t.is_active %}Yes{% else %}No{% endif %}
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="4" class="px-3 py-4 text-center text-slate-500">
              No country pricing defined yet for {{ subject.name }}.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

{% if anchor_zar_cents %}
<script>
(function () {
  var anchorCents = {{ anchor_zar_cents|int }};
  if (!anchorCents) return;

  var countryEl = document.getElementById('country_select');
  var rateEl    = document.getElementById('fx_rate');
  var localEl   = document.getElementById('local_amount_cents');
  var hintEl    = document.getElementById('local_amount_hint');

  if (!countryEl || !rateEl || !localEl || !hintEl) return;

  function updateHint(cents) {
    if (!cents || isNaN(cents) || cents <= 0) {
      hintEl.textContent = '';
      return;
    }
    var amt = (cents / 100).toFixed(2);
    hintEl.textContent = cents + ' cents (~' + amt + ' in local currency).';
  }

  function recalc() {
    var rateRaw = rateEl.value || '0';
    var rate = parseFloat(rateRaw.replace(',', '.'));
    if (!rate) return;

    var localCents = Math.round(anchorCents * rate);

    // Only auto-fill if admin has NOT typed manually
    if (localEl.dataset.userEdited !== '1') {
      localEl.value = localCents;
      updateHint(localCents);
    }
  }

  // When country changes, load FX from data-fx and recalc
  countryEl.addEventListener('change', function () {
    var opt = countryEl.options[countryEl.selectedIndex];
    if (!opt) return;

    var fx = opt.dataset.fx || '';
    // normalise decimal comma to dot
    fx = fx.replace(',', '.');

    rateEl.value = fx;
    localEl.dataset.userEdited = '';
    recalc();
  });

  // If admin edits FX manually, recompute (but still respect manual local if set)
  rateEl.addEventListener('input', function () {
    localEl.dataset.userEdited = '';
    recalc();
  });

  // If admin edits local manually, never overwrite it again
  localEl.addEventListener('input', function () {
    localEl.dataset.userEdited = '1';
    var cents = parseInt(localEl.value || '0', 10);
    updateHint(cents);
  });

})();
</script>
{% endif %}
{% endblock %}
