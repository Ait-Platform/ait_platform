{# templates/subject/loss/report_pdf.html #}
{# Stand-alone PDF template – no layout.html, no Exit instructions #}
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Loss Assessment Report</title>

    {# Base PDF styles (page size, fonts, margins, page-break rules) #}
    {% include "subject/loss/pdf/_styles_base.html" %}

    {# Shared chip / bar styles reused from web report #}
    {% include "subject/loss/pdf/_styles.html" %}

    <style>
      /* Keep header + first phase on same page as far as possible */
      .report-header,
      .phase-card {
        page-break-inside: avoid;
      }
      h1, h2, h3 {
        page-break-after: avoid;
      }
      body {
        margin: 18mm 15mm;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-size: 11pt;
        color: #111827;
      }
      .report-container {
        width: 100%;
      }
      .card-frame {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 10pt 12pt;
        margin-top: 10pt;
      }
      .card-frame-header {
        height: 3pt;
        border-radius: 12px 12px 0 0;
        background: #2563eb;
        margin: -10pt -12pt 8pt -12pt;
      }
      .card-frame-header--emerald {
        background: #059669;
      }
      .card-frame-header--slate {
        background: #4b5563;
      }
    </style>
  </head>

  <body>
    {# pdf_mode is already set in the view #}
    {% set pdf_mode = true %}

    {# ---- Safe defaults from context ---- #}
    {% set phase_labels = {1:'Impact', 2:'Hopelessness', 3:'Helplessness', 4:'Re-Engagement'} %}
    {% set blocks = phase_blocks | default([], true) %}
    {% set oa = overall_assessment | default(None) %}
    {% set viewer_is_admin = viewer_is_admin | default(false) %}

    {% set learner_name = (
      user.display_name if user is defined and user and user.display_name
      else (user.full_name if user and user.full_name
      else (user.email if user and user.email else 'Learner'))
    ) %}

    {% set dt_label = created_at if created_at is defined and created_at
                      else (started_at if started_at is defined else None) %}

    {# Derive P1–P4 if needed #}
    {% set ns = namespace(P1=None, P2=None, P3=None, P4=None) %}
    {% for b in blocks %}
      {% set v = (b.pct if b.pct is defined else (b.width_pct if b.width_pct is defined else 0)) | int %}
      {% if b.phase == 1 %}{% set ns.P1 = v %}{% endif %}
      {% if b.phase == 2 %}{% set ns.P2 = v %}{% endif %}
      {% if b.phase == 3 %}{% set ns.P3 = v %}{% endif %}
      {% if b.phase == 4 %}{% set ns.P4 = v %}{% endif %}
    {% endfor %}

    {% set P1 = (ns.P1 if ns.P1 is not none else (result.phase_1 if result is defined and result else 0)) | int %}
    {% set P2 = (ns.P2 if ns.P2 is not none else (result.phase_2 if result is defined and result else 0)) | int %}
    {% set P3 = (ns.P3 if ns.P3 is not none else (result.phase_3 if result is defined and result else 0)) | int %}
    {% set P4 = (ns.P4 if ns.P4 is not none else (result.phase_4 if result is defined and result else 0)) | int %}
    {% set total = (result.total if result is defined and result and result.total is not none else (P1 + P2 + P3 + P4)) | int %}

    <div class="report-container">

      {# Optional logo/header – uses data-URI if provided #}
      {% if logo_data_uri %}
        <div style="text-align:right; margin-bottom:8pt;">
          <img src="{{ logo_data_uri }}" alt="AIT" style="height:18pt;">
        </div>
      {% endif %}

      {# --- Title block (compact, no Exit text) --- #}
      <div class="report-header" style="margin-bottom:10pt;">
        <h1 style="font-size:16pt; margin:0 0 3pt 0;">Assessment Results</h1>
        <p style="margin:0; font-size:9.5pt; color:#4b5563;">
          Summary of your Loss of a Loved One (LOLO) assessment.
        </p>
      </div>

      {# --- Learner / run header row (your existing partial) --- #}
      {% include "subject/loss/pdf/_header.html" %}

      {% if blocks|length == 0 %}
        <div style="
          margin-top:8pt;
          padding:8pt 10pt;
          border-radius:8pt;
          border:1px solid #fcd34d;
          background:#fef9c3;
          color:#92400e;
          font-size:9.5pt;">
          No phase data available for this run.
        </div>
      {% endif %}

      {# ---------- Per-phase sections ---------- #}
      {% for blk in blocks %}
        {% set pct  = (blk.pct if blk.pct is defined else (blk.width_pct if blk.width_pct is defined else 0)) | int %}
        {% set band = blk.band if blk.band is defined else (3 if pct>=70 else (2 if pct>=40 else 1)) %}
        {% set range_label = 'High' if band==3 else ('Medium' if band==2 else 'Low') %}

        {% if blk.phase in [1,2,3] %}
          {% set av_txt     = 'Not Coping' if band==3 else ('Slightly Coping' if band==2 else 'Coping') %}
          {% set range_chip = 'chip-emerald' if band==1 else ('chip-amber' if band==2 else 'chip-rose') %}
          {% set bar_color  = 'bar-emerald' if band==1 else ('bar-amber' if band==2 else 'bar-rose') %}
        {% else %}
          {% set av_txt     = 'Coping' if band==3 else ('Slightly Coping' if band==2 else 'Not Coping') %}
          {% set range_chip = 'chip-blue' if band==1 else ('chip-lightemerald' if band==2 else 'chip-emerald') %}
          {% set bar_color  = 'bar-blue' if band==1 else ('bar-mint' if band==2 else 'bar-emerald') %}
        {% endif %}

        {% set av_chip = 'chip-av-coping' if av_txt=='Coping'
                         else ('chip-av-slightlycoping' if av_txt=='Slightly Coping' else 'chip-av-notcoping') %}

        <section class="phase-card" style="margin-top:10pt;">
          <div class="card-frame">
            {% include "subject/loss/pdf/_phase_heading.html" %}
            {% include "subject/loss/pdf/_hbar_safe.html" %}
            {% include "subject/loss/pdf/_phase_body.html" %}
            {% include "subject/loss/pdf/_progress.html" %}
          </div>
        </section>
      {% endfor %}

      {# ---------- Phase Summary ---------- #}
      <section style="margin-top:12pt; page-break-inside:avoid;">
        <div class="card-frame">
          {% include "subject/loss/pdf/_summary.html" %}
        </div>
      </section>

      {# ---------- Overall Assessment card ---------- #}
      <section style="margin-top:12pt; page-break-inside:avoid;">
        <div class="card-frame">
          {% include "subject/loss/pdf/_overall_assessment.html" %}
        </div>
      </section>

      {# ---------- Donation card ---------- #}
      <section style="margin-top:12pt; page-break-inside:avoid;">
        <div class="card-frame">
          {% include "subject/loss/pdf/_donation_bank_details.html" %}
        </div>
      </section>

      {# ---------- Disclaimer card ---------- #}
      <section style="margin-top:12pt; page-break-inside:avoid;">
        <div class="card-frame">
          {% include "subject/loss/pdf/_disclaimer.html" %}
        </div>
      </section>

    </div>
  </body>
</html>
