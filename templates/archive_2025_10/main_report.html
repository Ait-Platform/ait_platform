{# templates/subject/loss/report.html #}
{% extends "layout.html" %}
{% import "subject/loss/pdf/_macros.html" as M %}

{% block title %}Loss Results | AIT{% endblock %}

{% block content %}
{# —— Shared data —— #}
{% set phase_labels = {1:'Impact', 2:'Hopelessness', 3:'Helplessness', 4:'Re-Engagement'} %}
{% set blocks = phase_blocks | default([], true) %}
{% set oa = overall_assessment | default(None) %}
{% set viewer_is_admin = viewer_is_admin | default(false) %}
{% set pdf_mode = false %}
{# Graph & chip styles used by both on-screen and PDF #}
{% include "subject/loss/pdf/_styles.html" %}

{# —— Top bar —— #}
<div class="mx-auto w-full max-w-6xl px-6 py-6">
  <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
    <div>
      <h1 class="text-2xl font-semibold text-slate-900">Assessment Results</h1>
      <!--p class="text-sm text-slate-500">Run #{{ run_id }} • {{ taken_at or '' }}</p-->
    </div>

      {% if not pdf_mode %}
        <!--form method="post"
              action="{{ url_for('loss_bp.report_email_and_download', run_id=run_id) }}"
              class="mt-3 flex items-center gap-2 print:hidden">
          <input type="hidden" name="user_id" value="{{ user_id }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="email" name="to" required placeholder="you@example.com"
                class="rounded border px-3 py-2 text-sm" />
          <button type="submit"
                  class="rounded bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700">
            Email & Download PDF
          </button>
          <a href="{{ url_for('loss_bp.report_pdf_download', run_id=run_id, user_id=user_id) }}"
            class="rounded border px-3 py-2 text-sm hover:bg-slate-50">
            Download PDF
          </a>
        </form-->
      {% endif %}

      <form class="w-full md:w-auto"
            method="post"
            action="{{ url_for('loss_bp.report_send_and_download', run_id=run_id, user_id=user_id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="flex items-center gap-2">
          <label for="email" class="text-sm text-slate-600">Send to</label>
          <input id="email" name="email" type="email" required autocomplete="email"
                value="{{ default_email or '' }}"
                class="w-full md:w-80 rounded-lg border px-3 py-2 text-sm"
                placeholder="learner@example.com" />
          <button type="submit"
                  class="inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M16 12H8m8 0l-8 8m8-8l-8-8" />
            </svg>
            Email & Download PDF
          </button>
        </div>
        <p class="mt-1 text-xs text-slate-500">We’ll email the report to this address and download a copy now.</p>
      </form>

  </div>
</div>

{# —— Header (rows 1–3) —— #}
<div class="mx-auto w-full max-w-6xl px-6">
  {% include "subject/loss/pdf/_header.html" %}
</div>

<div class="mx-auto w-full max-w-6xl px-6 pb-8 space-y-6">
  {% if blocks|length == 0 %}
    <div class="rounded-xl border border-amber-200 p-4 bg-amber-50 text-amber-800">
      No phase data available for this run.
    </div>
  {% endif %}

  {# —— Phases —— #}
  {% for blk in blocks %}
    {% set pct  = (blk.pct if blk.pct is defined else (blk.width_pct if blk.width_pct is defined else 0)) | int %}
    {% set band = blk.band if blk.band is defined else (3 if pct>=70 else (2 if pct>=40 else 1)) %}

    {% if blk.phase in [1,2,3] %}
      {% set av_txt     = 'Not Coping' if band==3 else ('Slightly Coping' if band==2 else 'Coping') %}
      {% set range_chip = 'chip-emerald' if band==1 else ('chip-amber' if band==2 else 'chip-rose') %}
      {% set bar_color  = 'bar-emerald' if band==1 else ('bar-amber' if band==2 else 'bar-rose') %}
    {% else %}
      {% set av_txt     = 'Coping' if band==3 else ('Slightly Coping' if band==2 else 'Not Coping') %}
      {% set range_chip = 'chip-blue' if band==1 else ('chip-lightemerald' if band==2 else 'chip-emerald') %}
      {% set bar_color  = 'bar-blue' if band==1 else ('bar-mint' if band==2 else 'bar-emerald') %}
    {% endif %}
    {% set av_chip = 'chip-av-coping' if av_txt=='Coping'
                    else ('chip-av-slightlycoping' if av_txt=='Slightly Coping' else 'chip-av-notcoping') %}

    <section class="phase-card rounded-2xl border border-slate-200 p-5 bg-white">
      {% include "subject/loss/pdf/_phase_heading.html" %}
      {% include "subject/loss/pdf/_bar_graph.html" %}
      {% include "subject/loss/pdf/_phase_body.html" %}
      {% include "subject/loss/pdf/_progress.html" %}
    </section>
  {% endfor %}

{# —— Phase Summary —— #}
{% include "subject/loss/pdf/_summary.html" %}



{# —— Overall Assessment —— #}
{% include "subject/loss/pdf/_overall_assessment.html" %}

{# —— Disclaimer —— #}
{% include "subject/loss/pdf/_disclaimer.html" %}

</div>  {# closes the .max-w-6xl container if you opened one earlier #}
{% endblock %}

