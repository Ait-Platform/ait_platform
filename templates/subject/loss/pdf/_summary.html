{# templates/subject/loss/pdf/_summary.html — robust, CSS-free #}

{# We'll accumulate the four percentages into NS.* #}
{% set NS = namespace(P1=None, P2=None, P3=None, P4=None) %}

{# --- 1) Preferred dicts already holding percentages --- #}
{% if phase_scores_pct is defined and phase_scores_pct %}
  {% if phase_scores_pct.get is defined %}
    {% set NS.P1 = (phase_scores_pct.get('P1', phase_scores_pct.get('phase_1', 0))) | int %}
    {% set NS.P2 = (phase_scores_pct.get('P2', phase_scores_pct.get('phase_2', 0))) | int %}
    {% set NS.P3 = (phase_scores_pct.get('P3', phase_scores_pct.get('phase_3', 0))) | int %}
    {% set NS.P4 = (phase_scores_pct.get('P4', phase_scores_pct.get('phase_4', 0))) | int %}
  {% elif phase_scores_pct is sequence and phase_scores_pct is not string and (phase_scores_pct|length) >= 4 %}
    {% set NS.P1 = (phase_scores_pct[0] | default(0)) | int %}
    {% set NS.P2 = (phase_scores_pct[1] | default(0)) | int %}
    {% set NS.P3 = (phase_scores_pct[2] | default(0)) | int %}
    {% set NS.P4 = (phase_scores_pct[3] | default(0)) | int %}
  {% endif %}
{% endif %}

{% if (NS.P1 is none or NS.P2 is none or NS.P3 is none or NS.P4 is none)
      and loss_result_percents is defined and loss_result_percents %}
  {% if loss_result_percents.get is defined %}
    {% set NS.P1 = (NS.P1 if NS.P1 is not none else loss_result_percents.get('P1', 0) | int) %}
    {% set NS.P2 = (NS.P2 if NS.P2 is not none else loss_result_percents.get('P2', 0) | int) %}
    {% set NS.P3 = (NS.P3 if NS.P3 is not none else loss_result_percents.get('P3', 0) | int) %}
    {% set NS.P4 = (NS.P4 if NS.P4 is not none else loss_result_percents.get('P4', 0) | int) %}
  {% endif %}
{% endif %}

{# --- 2) Compute from a raw result mapping (phase_* and max_phase_*) --- #}
{% if (NS.P1 is none or NS.P2 is none or NS.P3 is none or NS.P4 is none)
      and result_row is defined and result_row and result_row.get is defined %}
  {% set v1 = (result_row.get('phase_1', 0) or 0) | float %}
  {% set v2 = (result_row.get('phase_2', 0) or 0) | float %}
  {% set v3 = (result_row.get('phase_3', 0) or 0) | float %}
  {% set v4 = (result_row.get('phase_4', 0) or 0) | float %}
  {% set m1 = (result_row.get('max_phase_1', 100) or 100) | float %}
  {% set m2 = (result_row.get('max_phase_2', 100) or 100) | float %}
  {% set m3 = (result_row.get('max_phase_3', 100) or 100) | float %}
  {% set m4 = (result_row.get('max_phase_4', 100) or 100) | float %}
  {% set NS.P1 = (NS.P1 if NS.P1 is not none else (0 if m1 <= 0 else (100 * v1 // m1) | int)) %}
  {% set NS.P2 = (NS.P2 if NS.P2 is not none else (0 if m2 <= 0 else (100 * v2 // m2) | int)) %}
  {% set NS.P3 = (NS.P3 if NS.P3 is not none else (0 if m3 <= 0 else (100 * v3 // m3) | int)) %}
  {% set NS.P4 = (NS.P4 if NS.P4 is not none else (0 if m4 <= 0 else (100 * v4 // m4) | int)) %}
{% endif %}

{# --- 3) Compute from a result object with attributes --- #}
{% if (NS.P1 is none or NS.P2 is none or NS.P3 is none or NS.P4 is none) and result is defined and result %}
  {% set v1 = (result.phase_1 or 0) | float %}
  {% set v2 = (result.phase_2 or 0) | float %}
  {% set v3 = (result.phase_3 or 0) | float %}
  {% set v4 = (result.phase_4 or 0) | float %}
  {% set m1 = (result.max_phase_1 or 100) | float %}
  {% set m2 = (result.max_phase_2 or 100) | float %}
  {% set m3 = (result.max_phase_3 or 100) | float %}
  {% set m4 = (result.max_phase_4 or 100) | float %}
  {% set NS.P1 = (NS.P1 if NS.P1 is not none else (0 if m1 <= 0 else (100 * v1 // m1) | int)) %}
  {% set NS.P2 = (NS.P2 if NS.P2 is not none else (0 if m2 <= 0 else (100 * v2 // m2) | int)) %}
  {% set NS.P3 = (NS.P3 if NS.P3 is not none else (0 if m3 <= 0 else (100 * v3 // m3) | int)) %}
  {% set NS.P4 = (NS.P4 if NS.P4 is not none else (0 if m4 <= 0 else (100 * v4 // m4) | int)) %}
{% endif %}

{# --- 4) Last resort: derive from phase_blocks/blocks (needs namespace updates) --- #}
{% if NS.P1 is none or NS.P2 is none or NS.P3 is none or NS.P4 is none %}
  {% set B = phase_blocks if phase_blocks is defined and phase_blocks else (blocks if blocks is defined else []) %}
  {% for blk in B %}
    {% set phase = (blk.phase if blk.phase is defined else (blk.get('phase') if blk.get is defined else None)) %}
    {% set pct   = (blk.pct   if blk.pct   is defined else (blk.get('pct')   if blk.get is defined else None)) %}
    {% if pct is none %}
      {% set pct = (blk.width_pct if blk.width_pct is defined else (blk.get('width_pct') if blk.get is defined else 0)) %}
    {% endif %}
    {% set pct = (pct or 0) | int %}
    {% if phase == 1 and NS.P1 is none %}{% set NS.P1 = pct %}{% endif %}
    {% if phase == 2 and NS.P2 is none %}{% set NS.P2 = pct %}{% endif %}
    {% if phase == 3 and NS.P3 is none %}{% set NS.P3 = pct %}{% endif %}
    {% if phase == 4 and NS.P4 is none %}{% set NS.P4 = pct %}{% endif %}
  {% endfor %}
{% endif %}

{# Final clamps and fallbacks to 0 #}
{% set P1 = (NS.P1 if NS.P1 is not none else 0) | int %}
{% set P2 = (NS.P2 if NS.P2 is not none else 0) | int %}
{% set P3 = (NS.P3 if NS.P3 is not none else 0) | int %}
{% set P4 = (NS.P4 if NS.P4 is not none else 0) | int %}
{% set P1 = 0 if P1 < 0 else (100 if P1 > 100 else P1) %}
{% set P2 = 0 if P2 < 0 else (100 if P2 > 100 else P2) %}
{% set P3 = 0 if P3 < 0 else (100 if P3 > 100 else P3) %}
{% set P4 = 0 if P4 < 0 else (100 if P4 > 100 else P4) %}
{% set R1 = 100 - P1 %}{% set R2 = 100 - P2 %}{% set R3 = 100 - P3 %}{% set R4 = 100 - P4 %}

<!-- Wrapper card (plain HTML, PDF-safe) -->
<table border="1" cellpadding="12" cellspacing="0" width="100%">
  <tr><td>

    <table border="0" cellpadding="0" cellspacing="0" width="100%">
      <tr><td><b>Phase Summary</b></td></tr>
      <tr><td><font size="2">You are experiencing these feelings as shown under Comments in these phases</font></td></tr>
    </table>

    <!-- Bullets -->
    <table border="0" cellpadding="2" cellspacing="0" width="100%">
      <tr><td>• Phase 1: Impact: {{ P1 }}% of the time.</td></tr>
      <tr><td>• Phase 2: Hopelessness: {{ P2 }}% of the time.</td></tr>
      <tr><td>• Phase 3: Helplessness: {{ P3 }}% of the time.</td></tr>
      <tr><td>• Phase 4: Re-Engagement: {{ P4 }}% of the time.</td></tr>
    </table>

    <!-- Graph title -->
    <table border="0" cellpadding="8" cellspacing="0" width="100%">
      <tr><td><b>Phase Graph</b></td></tr>
    </table>

    {# If a pre-rendered image (data: URI) was provided by the route, show it #}
    {% if phase_scores_chart_src %}
      <table border="0" cellpadding="0" cellspacing="0" width="100%">
        <tr><td align="left"><img src="{{ phase_scores_chart_src }}" alt="Phase Scores"></td></tr>
      </table>
    {% else %}
      {# Simple HTML bars as a fallback (no CSS) #}
      {% set rows = [
        ('Impact', P1, R1, P1),
        ('Hopelessness', P2, R2, P2),
        ('Helplessness', P3, R3, P3),
        ('Re-Engagement', P4, R4, P4),
      ] %}
      <table border="0" cellpadding="4" cellspacing="0" width="100%">
        {% for label, left, right, pct in rows %}
          <tr>
            <td width="140"><font size="2">{{ label }}</font></td>
            <td>
              <table border="0" cellpadding="0" cellspacing="0" width="100%">
                <tr>
                  <td width="{{ left }}%"  height="10" bgcolor="#22c55e"></td>
                  <td width="{{ right }}%" height="10" bgcolor="#e2e8f0"></td>
                </tr>
              </table>
            </td>
            <td width="40" align="right"><font size="2">{{ pct }}%</font></td>
          </tr>
        {% endfor %}
      </table>
    {% endif %}

  </td></tr>
</table>
<div>
  <section class="rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden">
    <!-- top color strip (match brand) -->
    <div class="h-2 w-full bg-blue-600"></div>

    <div class="p-5">
      <h2 class="text-lg md:text-xl font-semibold text-slate-900 mb-2">
        How to read your Phase Summary
      </h2>

      <p class="text-sm text-slate-700 mb-3">
        The percentages above show how often each phase is present for you right now.
      </p>

      <ul class="text-sm text-slate-700 list-disc pl-5 space-y-1">
        <li><span class="font-medium">Impact</span> — immediate intensity or shock.</li>
        <li><span class="font-medium">Hopelessness</span> — feeling stuck or without options.</li>
        <li><span class="font-medium">Helplessness</span> — low sense of control or confidence.</li>
        <li><span class="font-medium">Re-Engagement</span> — returning to routines and confidence.</li>
      </ul>

      <p class="text-sm text-slate-700 mt-3">
        Higher percentages mean that phase is showing up more frequently. Focus first on the
        highest phase(s), and use the comments and guidance in this report to plan small,
        specific next steps.
      </p>
    </div>
  </section>

</div>