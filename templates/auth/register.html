<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Create your account</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  {% set values = values or {} %}
  {% set errors = errors or {} %}

  {% set display_subject = (subject or display_subject or 'loss') %}
  {% set display_role    = (role or display_role or 'learner') %}

  <main class="flex items-center justify-center min-h-screen px-4">
    <section class="w-full max-w-md bg-white rounded-2xl shadow-sm ring-1 ring-slate-200 p-6">
      <h1 class="text-2xl font-semibold tracking-tight">Create your account</h1>
      <p class="mt-1 text-slate-600 text-sm">
        {{ display_subject|capitalize }} • {{ display_role|capitalize }}
      </p>

      {% if banner %}
        <div class="mt-4 rounded-lg px-3 py-2 text-sm ring-1 bg-emerald-50 text-emerald-700 ring-emerald-200">
          {{ banner }}
        </div>
      {% endif %}

      {% if errors.get('_form') %}
        <div class="mt-4 rounded-lg border border-rose-300 bg-rose-50 text-rose-800 px-3 py-2 text-sm">
          {{ errors['_form'] }}
        </div>
      {% endif %}

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="mt-3 rounded-lg border border-rose-300 bg-rose-50 text-rose-800 px-3 py-2 text-sm">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form method="POST" action="{{ url_for('auth_bp.register') }}" class="mt-6 space-y-4">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="subject" value="{{ subject or '' }}">
        <input type="hidden" name="role" value="{{ role or '' }}">
        <input type="hidden" name="next" value="{{ next_url or '/' }}">

        <div>
          <label for="full_name" class="block text-sm font-medium text-slate-700">Full name</label>
          <input id="full_name" name="full_name" required
                value="{{ request.form.full_name or values.get('full_name','') }}"
                class="mt-1 block w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200" />
        </div>

        <div>
          <label for="email" class="block text-sm font-medium text-slate-700">Email</label>
          <input id="email" type="email" name="email" required
                value="{{ request.form.email or values.get('email','') }}"
                class="mt-1 block w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200" />
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-slate-700">Password</label>
          <input id="password" type="password" name="password" minlength="8" required
                class="mt-1 block w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200" />
          <p class="mt-1 text-xs text-slate-500">At least 8 characters.</p>
        </div>

        <button type="submit"
          class="w-full inline-flex items-center justify-center rounded-xl bg-sky-600 text-white px-4 py-2.5 text-sm font-medium shadow-sm hover:bg-sky-700">
          Continue
        </button>
      </form>
      
    </section>
 
<script>
(function(){
  const input = document.getElementById('country');
  const list  = document.getElementById('country-options');
  if (!input || !list) return;

  let last = '';
  let t;

  async function fetchCountries(q){
    try{
      const r = await fetch(`/api/countries?q=${encodeURIComponent(q)}`, {
        headers: {'Accept':'application/json'}
      });
      if (!r.ok) return [];
      return await r.json(); // [{name, code}]
    } catch { return []; }
  }

  function render(options){
    // Show "CODE — Name" in the dropdown while keeping the value as the name
    list.innerHTML = options.map(c => {
      const code = (c.code || '').toUpperCase();
      const label = code ? `${code} — ${c.name}` : c.name;
      return `<option value="${c.name}" label="${label}"></option>`;
    }).join('');
  }

  async function maybeAutofillByCode(q){
    // If user typed a 2-letter code (like QA), auto-fill to the country name when unambiguous
    if (q.length === 2 && /^[a-z]{2}$/i.test(q)) {
      const rows = await fetchCountries(q);
      const upper = q.toUpperCase();
      const hit = rows.find(c => (c.code || '').toUpperCase() === upper);
      if (hit) {
        input.value = hit.name;  // replace "QA" with "Qatar"
        render(rows);            // keep suggestions visible if they press ↓
      }
    }
  }

  input.addEventListener('input', () => {
    const q = input.value.trim();
    if (q === last) return;
    last = q;

    clearTimeout(t);
    if (!q) { list.innerHTML = ''; return; }

    t = setTimeout(async () => {
      const rows = await fetchCountries(q);
      render(rows);
      // If they typed a 2-letter code, try to auto-fill
      maybeAutofillByCode(q);
    }, 120);
  });
})();
</script>




  </main>
</body>
</html>
